# üìú LOG MAESTRO: El Or√°culo de Nueva Eternia



## Estado Actual: [SISTEMA OPERATIVO, AUDITADO Y REVERSIBLE]



Este documento registra la evoluci√≥n t√©cnica y estrat√©gica del Or√°culo. La Phase 4 ha sido completada con √©xito, transformando la herramienta en una SPA moderna orientada a la inteligencia de mercado y la gesti√≥n de colecciones, con capacidad de auditor√≠a total.



---



## CRONOLOG√çA DE VICTORIAS



### Fase 1: Despertar de la Conciencia (Backend Core)

- **Hitos**: Scrapers para 10 tiendas, base de datos SQLite y SmartMatcher original.

- **Estado**: ‚úÖ COMPLETADO Y MIGRAD√ì



### Fase 2: El Eco de las Reliquias (Frontend MVP)

- **Hitos**: Interfaz Streamlit, visualizaci√≥n b√°sica y sistema de auditor√≠a.

- **Estado**: ‚úÖ COMPLETADO



### Fase 3: Puente hacia las Nubes (Cloud Architecture)

- **Hitos**: Preparaci√≥n para Supabase, GitHub Actions y arquitectura de sincronizaci√≥n.

- **Estado**: ‚úÖ COMPLETADO



### Fase 4: Revoluci√≥n UX (La Nueva Era)

- **Hitos**: Migraci√≥n a React 19, Tailwind CSS y Dashboard de Inteligencia.

- **Estado**: ‚úÖ VALIDADO



#### 4.1 Core UX & Navegaci√≥n

- **Hitos**: Sidebar din√°mica, Navbar premium y sistema de Tabs (SPA).

- **Estado**: ‚úÖ VALIDADO



#### 4.2 La Fortaleza (Colecci√≥n)

- **Hitos**: Sistema de "Captura" de items, gesti√≥n de stock personal y valoraci√≥n de colecci√≥n.

- **Estado**: ‚úÖ VALIDADO



#### 4.3 El Espejo (Purgatorio)

- **Hitos**: SmartMatcher manual, control de scrapers protegido y bit√°cora de incursiones.

- **Estado**: ‚úÖ VALIDADO



#### 4.4 Tablero de Inteligencia (Dashboard)

- **Hitos**: Centro de mando con m√©tricas de valor, radar de Eternia y Top Deals.

- **Estado**: ‚úÖ VALIDADO



#### 4.5 Radar de V√≠nculos (Trazabilidad)

- **Hitos**: Registro persistente de v√≠nculos manuales, conteo por tienda y historial de actividad.

- **Estado**: ‚úÖ VALIDADO



#### 4.6 Basti√≥n de Justicia (Reversi√≥n)

- **Hitos**: Implementaci√≥n del sistema de "Deshacer" para v√≠nculos y descartes. Restauraci√≥n √≠ntegra de metadatos al Purgatorio.

- **Estado**: ‚úÖ VALIDADO



### Fase 5: Refinamiento T√°ctico (La Gran Purificaci√≥n)

- **Hitos**: Reingenier√≠a de calidad de datos y "Verdad del Or√°culo".

- **Estado**: ‚úÖ VALIDADO



#### 5.1 La Gran Purificaci√≥n (Reset Total)

- **Hitos**: Capacidad de enviar TODAS las ofertas vinculadas al Purgatorio para re-verificaci√≥n masiva.

- **Estado**: ‚úÖ COMPLETADO



#### 5.2 Purgatorio v2 (Inteligencia Guiada)

- **Hitos**: Motor de sugerencias en tiempo real. Muestra coincidencias ordenadas por score (30%+).

- **Estado**: ‚úÖ COMPLETADO



#### 5.3 SmartMatch 2.0 (Umbral de Calidad)

- **Hitos**: Elevaci√≥n del est√°ndar de auto-vinculaci√≥n al 75%. Lo que no es seguro, va al Purgatorio.

- **Estado**: ‚úÖ COMPLETADO



#### 5.4 Sincronizaci√≥n de M√©tricas (Real-Time Truth)

- **Hitos**: Tablero conectado directamente a `OfferModel`. Las m√©tricas de "V√≠nculos Sagrados" y "Conquistas" son din√°micas al instante.

- **Estado**: ‚úÖ COMPLETADO



- **Hitos**: Indicadores "Live" (brillo cyan) y badge para productos con ofertas de mercado activas.

- **Estado**: ‚úÖ COMPLETADO



### Fase 6: Innovaci√≥n (El Tesoro de Grayskull)

- **Hitos**: Motor Financiero, Detecci√≥n de Griales y Estabilizaci√≥n de Infraestructura.

- **Estado**: üèóÔ∏è EN PROGRESO



#### 6.1 Motor Financiero (Market Value)

- **Hitos**: C√°lculo de valor real de colecci√≥n vs inversi√≥n. M√©tricas financieras en Dashboard.

- **Estado**: ‚úÖ COMPLETADO Y ESTABILIZADO (PostgreSQL)



#### 6.2 Detector de Griales (High Value)

- **Hitos**: Identificaci√≥n autom√°tica de tesoros (ROI > 50% o Valor > 150‚Ç¨). UI Premium (Borde Dorado/Trofeo) en Mi Fortaleza. Estandarizaci√≥n a Euro (‚Ç¨).

- **Estado**: ‚úÖ COMPLETADO



#### 6.3 Visionary Dashboard (Inteligencia de Mercado)

- **Hitos**: Implementaci√≥n del endpoint `/hall-of-fame` y widgets frontend "Griales del Reino" (Top Valor) y "Potencial Oculto" (Top ROI).

- **Estado**: ‚úÖ COMPLETADO





---



### Fase 7: Adaptaci√≥n H√≠brida (Mobile First)

- **Hitos**: Responsive Design integral, Widgets compactos y Estabilidad de datos.

- **Estado**: ‚úÖ COMPLETADO Y ESTABILIZADO



#### 7.1 Navegaci√≥n L√≠quida

- **Hitos**: Sidebar/Drawer m√≥vil y Navbar t√°ctil.

- **Estado**: ‚úÖ COMPLETADO



#### 7.2 Optimizaci√≥n T√°ctil (UI Compacta)

- **Hitos**: Layouts "Compact Ticket" en Purgatorio y Grillas 2-Col en Colecci√≥n. Reintegraci√≥n de Enlace Externo.

- **Estado**: ‚úÖ COMPLETADO



#### 7.3 Estabilidad del Purgatorio (Atomic Safety)

- **Hitos**: Soluci√≥n definitiva a `Duplicate Key Error` mediante transacciones anidadas. Blindaje CSS contra desbordamientos.

- **Estado**: ‚úÖ COMPLETADO



#### 7.4 Integridad de Dashboard (Data Consistency)

- **Hitos**: Correcci√≥n de discrepancia visula entre contadores y gr√°ficos. Implementaci√≥n de c√°lculo derivado (`sum(distribuci√≥n)`) para garantizar coherencia matem√°tica absoluta y correcci√≥n de `NameError` en runtime.

- **Estado**: ‚úÖ COMPLETADO



#### 7.5 Refinamiento UX Purgatorio (Auto-Clear)

- **Hitos**: Mejora de calidad de vida. El buscador manual ahora se reinicia autom√°ticamente al completar una vinculaci√≥n o cambiar el foco a otro item, eliminando la fricci√≥n de borrar texto anterior.

- **Estado**: ‚úÖ COMPLETADO



> [!NOTE]

> **Norma Operativa**: A partir de este hito, todos los t√≠tulos y descripciones para commits de GitHub deber√°n redactarse estrictamente en **ESPA√ëOL** para mantener la coherencia con el idioma nativo del proyecto "Or√°culo de Eternia".



---



### Fase 8: Omnipresencia (Dockerizaci√≥n)

- **Hitos**: Encapsulamiento total en contenedores y preparaci√≥n para despliegue industrial (NAS/VPS).

- **Estado**: ‚úÖ COMPLETADO (Estructura)



#### 8.1 El Arca (Dockerizaci√≥n Integral)

- **Hitos**: Creaci√≥n de `Dockerfile` para Backend (Python/Playwright) y Frontend (Nginx). Implementaci√≥n de `launch_ark.ps1` y accesos directos.

- **Estado**: ‚úÖ COMPLETADO



#### 8.2 Blindaje de Producci√≥n (Grado Industrial)

- **Hitos**: Orquestaci√≥n estable con `docker-compose.prod.yml`, persistencia de datos via vol√∫menes y creaci√≥n del sistema "Guardi√°n de Datos" para backups autom√°ticos. Apertura de CORS para acceso universal m√≥vil.

- **Estado**: ‚úÖ COMPLETADO



#### 8.2.1 Sincronizaci√≥n Universal (Cloud Jump)

- **Hitos**: Transvase exitoso de toda la colecci√≥n local y cat√°logo a Supabase.

- **Estado**: ‚úÖ COMPLETADO



#### 8.2.2 Gesti√≥n de Identidad y Restauraci√≥n

- **Hitos**: Activaci√≥n del usuario "David" (ID 2). Reasignaci√≥n at√≥mica de los 75 items de "La Fortaleza" desde el admin al perfil personal de David. Verificaci√≥n del esquema `UserModel`.

- **Estado**: ‚úÖ COMPLETADO



#### 8.2.3 Multiusuario Fluido (Inyectando Conciencia)

- **Hitos**: Implementaci√≥n del "Interruptor de H√©roes" en la Navbar con persistencia en `localStorage`. Filtrado at√≥mico por `user_id` en los motores del Dashboard (Stats, Top Deals, Hall of Fame). El sistema ahora distingue entre la colecci√≥n de David y la vista de gesti√≥n del Admin.

- **Estado**: ‚úÖ COMPLETADO



### üè∞ Fase 9: El Legado de Eternia (Poderes por Perfil)

Esta fase ha dividido el Or√°culo en dos experiencias potentes y diferenciadas:



#### 9.1 El Arquitecto (Poderes de Admin)

- **Mando de Scrapers**: Central de control para activar incursiones manuales por tienda con visualizaci√≥n de logs de ejecuci√≥n en tiempo real (Items encontrados, errores, tiempos).

- **Editor de la Verdad**: Herramienta de edici√≥n directa en el cat√°logo para corregir metadatos (Nombres, EANs, Categor√≠as).

- **Radar de Duplicados & Fusi√≥n**: Motor de detecci√≥n por EAN que permite fusionar dos productos transfiriendo ofertas y registros de propiedad sin p√©rdida de datos.

- **Descarte Masivo**: Interfaz de selecci√≥n m√∫ltiple en el Purgatorio con barra de acciones flotante para limpieza a gran escala.

- **Estado**: ‚úÖ COMPLETADO



#### 9.2 El Guardi√°n (Experiencia David)

- **Lista de Deseos (Wishlist)**: Implementaci√≥n de la l√≥gica de "Target" donde David puede marcar futuras adquisiciones sin ensuciar sus m√©tricas de inversi√≥n reales.

- **La Fortaleza 2.0**: Redise√±o de la p√°gina de colecci√≥n con sistema de pesta√±as (Pose√≠do/Deseado) y est√©ticas premium con efectos de brillo y tarjetas din√°micas.

- **Upgrade de Reliquias**: Al adquirir un item de la wishlist, el sistema permite "Reclamarlo" con un clic, marc√°ndolo como pose√≠do y solicitando el precio de compra real.

- **Estado**: ‚úÖ COMPLETADO



### üõ†Ô∏è Mec√°nica T√©cnica y Dockerizaci√≥n (Resumen de Arquitectura)



Para garantizar que el Or√°culo sea indestructible y portable, hemos implementado las fases 8.2 y 8.3 bajo estos pilares:



#### üë§ Gesti√≥n de Identidad (Multi-Hero System)

*   **Restauraci√≥n At√≥mica**: El perfil de **David** fue activado y sus 75 items reasignados mediante el script `restore_david.py`. La base de datos en Supabase ahora vincula cada item al `owner_id` correspondiente.

*   **Identidad Persistente**: El Frontend usa `localStorage` (`active_user_id`) para recordar qui√©n ha entrado. Al cambiar de usuario en la Navbar, se refresca la sesi√≥n para inyectar el ID en todas las llamadas de la API.

*   **Filtrado en el Backend**: Los endpoints de la API (`/stats`, `/top-deals`, `/hall-of-fame`) han sido actualizados para filtrar resultados por el `user_id` recibido, garantizando que David vea su ROI personal y el Admin vea la salud global.



#### üê≥ Sincronizaci√≥n en el Arca (Docker)

*   **Desarrollo L√≠quido**: El entorno Docker est√° vinculado a la carpeta del proyecto mediante vol√∫menes. Esto permite que cualquier cambio en el c√≥digo (como el nuevo selector de perfiles) se refleje en los contenedores al instante sin reconstruir im√°genes.

*   **Persistencia Blindada**: Aunque los contenedores se detengan o actualicen, la base de datos local y los logs est√°n mapeados fuera del Docker. Esto asegura que la "Fortaleza de Datos" sea inmune a reinicios.

*   **Escalabilidad NAS/VPS**: Al estar 100% Dockerizado, el Or√°culo puede migrar a un servidor externo simplemente copiando la carpeta y lanzando el script, manteniendo todas las identidades y configuraciones intactas.



---



## PLAN DE VERIFICACI√ìN (P√öLSAR)

1. **Radar**: Los v√≠nculos manuales se reflejan instant√°neamente en el Tablero.

- **8.3 Cronos**: Hist√≥rico de Precios premium integrado en Cat√°logo. ‚úÖ COMPLETADO

- **8.4 Expansi√≥n Continental**: Integraci√≥n de tiendas TOP europeas.



---



### üîç Fase 10: Infiltraci√≥n en los Grandes Mercados (APIs & Scraping)

Iniciada tras la consolidaci√≥n de Cronos, esta fase busca el dominio de los precios globales.

- **Inteligencia Amazon**: Definida estrategia para amazon.es centrada en monitoreo de precios (PA-API 5.0).

- **Inteligencia eBay**: Preparado conector OAuth 2.0 para Browse API (B√∫squeda de subastas y ventas directas).

- **Inteligencia Wallapop**: Identificada API interna v3 y headers cr√≠ticos para bypass de seguridad.

- **Monitorizaci√≥n de Ventas**: Investigando m√©todos para rastrear no solo precios, sino transacciones reales de MOTU Origins.



---



### üß† Sabidur√≠a de los Grandes Mercados (Marketplace Intelligence)



Para la expansi√≥n a los "Tres Titanes" (Amazon, eBay, Wallapop), el Or√°culo ha sintetizado las siguientes reglas de infiltraci√≥n:



#### üì¶ Amazon.es (El Gigante de la Log√≠stica)

*   **Misi√≥n**: Vigilancia de precios en Espa√±a para detectar bajadas repentinas de stock oficial de Mattel.

*   **T√©cnica**: Uso de `PA-API 5.0` via `python-amazon-paapi`. Requiere cuenta de Afiliados con 3 ventas previas.

*   **Enfoque**: No ventas, solo extracci√≥n de `LowestNewPrice` y `OfferListingId`.



#### üèõÔ∏è eBay (La Sala de Subastas Global)

*   **Misi√≥n**: Capturar el valor real de mercado mediante subastas y ventas hist√≥ricas.

*   **T√©cnica**: `Browse API` con flujo `Client Credentials`. B√∫squeda por palabras clave con filtros de categor√≠a espec√≠ficos de coleccionismo.

*   **Valor**: eBay es el est√°ndar de oro para valorar piezas antiguas o raras de MOTU Origins.



#### ü§ù Wallapop (El Mercado del Pueblo)

*   **Misi√≥n**: Rastrear el pulso de la segunda mano y coleccionistas locales en Espa√±a.

*   **T√©cnica**: Infiltraci√≥n en la API interna (`api.wallapop.com/api/v3`) usando headers de dispositivo (`X-DeviceOS`) y User-Agents espec√≠ficos.

*   **Desaf√≠o**: Gesti√≥n de proxies para evitar el ban de Cloudflare/DataDome.



#### üìä Espionaje de Ventas Reales (Sales Monitoring)

Para capturar no solo el precio de oferta, sino el precio de transacci√≥n real, el Or√°culo emplear√° estas t√°cticas:



*   **Action Figure 411 (El Or√°culo Aliado)**: Es la fuente m√°s limpia. Scrapearemos su gu√≠a de precios de MOTU Origins para obtener promedios de venta y listados de subastas finalizadas ya filtrados de ruido.

*   **eBay (Sold Listings)**: Infiltraci√≥n mediante scraping de `&LH_Sold=1&LH_Complete=1`. Esto nos dar√° el pulso exacto de lo que los coleccionistas espa√±oles est√°n pagando **hoy**.

*   **Wallapop (Status Tracker)**: Monitorizaci√≥n selectiva de productos. Cuando un item desaparece o cambia a `status: sold`, el Or√°culo registrar√° la √∫ltima cifra conocida como precio de venta probable.

*   **Amazon (BSR Analysis)**: Seguimiento del `SalesRank` via PA-API. Una ca√≠da brusca en el ranking es un indicador directo de volumen de ventas.



---



## PLAN DE VERIFICACI√ìN (P√öLSAR)

1. **Radar**: Los v√≠nculos manuales se reflejan instant√°neamente en el Tablero.

2. **Justicia**: Cada acci√≥n en el historial permite reversi√≥n inmediata con un clic.

3. **M√©tricas**: El Tablero calcula el valor total bas√°ndose en los items de "La Fortaleza".

4. **Movilidad**: Operatividad total verificada en resoluciones m√≥viles y acceso via Docker/Nginx.



## PR√ìXIMOS PASOS (EL OJO DE SAURON)

### Fase 8.4 & 8.4b: Expansi√≥n Continental y Avanzada

- **Hitos**: Integraci√≥n de 6 nuevas tiendas internacionales (Holanda, Alemania, Italia, Europa, USA) y optimizaci√≥n stealth para GitHub Actions.

- **Estado**: ‚úÖ COMPLETADO Y VERIFICADO



#### üåç El Or√°culo Global (11 Tiendas Activas)

El Or√°culo ahora monitoriza 11 fuentes de datos con tecnolog√≠as espec√≠ficas para cada una:



1.  **Espa√±a (5)**: ActionToys, Fantasia, Frikiverso, Pixelatoy, Electropolis (WooCommerce/Prestashop).

2.  **Europa (3)**: 

    *   `DeToyboys_scraper.py` (Holanda): Gesti√≥n de stock NL.

    *   `Motuclassics_de_scraper.py` (Alemania): Shopware crawler.

    *   `Vendiloshop_scraper.py` (Italia): Precios en Euros competitivos.

3.  **Avanzado (3)**:

    *   `Toymi_scraper.py` (EU): Paginaci√≥n optimizada (102 productos detectados mediante `?af=60`).

    *   `Time4ActionToys_scraper.py` (Alemania): Gran volumen (273 productos) con paginaci√≥n industrial.

    *   `BBTS_scraper.py` (USA): **Stealth Mode** avanzado (Playwright, fingerprint spoofing, init scripts anti-detecci√≥n) para saltar Cloudflare desde GitHub Actions.



#### üîß Mejoras de Infraestructura y Datos

*   **Bypass de Cloudflare**: Implementaci√≥n de t√©cnicas de evasi√≥n en `BBTS_scraper.py` (Timezone USA, Geo-spoofing, movimientos humanizados).

*   **Correcci√≥n de BaseScraper**: Reparado bug cr√≠tico de importaci√≥n en `base.py` que afectaba a la generaci√≥n de User-Agents aleatorios.

*   **Optimizaci√≥n de Carga**: Configuraci√≥n de `af=60` en Toymi para maximizar la eficiencia por cada incursi√≥n.

*   **Blindaje de Build (Docker)**: Correcci√≥n de errores de TypeScript en `Catalog.tsx`, `Config.tsx` y `Dashboard.tsx` para garantizar el despliegue industrial.

*   **Restauraci√≥n de Propiedad**: Reasignaci√≥n at√≥mica de 75 items a la cuenta de David (ID 2), corrigiendo la discrepancia financiera en el Dashboard personal.

*   **Inteligencia de Mercado (Top Deals)**: Implementaci√≥n de deduplicaci√≥n por producto y filtrado din√°mico por `owner_id`. El widget ahora solo muestra "lo mejor de lo que no tienes".



---



## PLAN DE VERIFICACI√ìN (P√öLSAR)

1. **Radar**: Los v√≠nculos manuales se reflejan instant√°neamente en el Tablero.

2. **Justicia**: Cada acci√≥n en el historial permite reversi√≥n inmediata con un clic.

3. **M√©tricas**: El Tablero calcula el valor total bas√°ndose en los items de "La Fortaleza".

4. **Scrapers**: Verificados mediante `test_european_scrapers.py` y logs de `daily_scan.py`.



---



### Fase 10: Infiltraci√≥n en los Grandes Mercados

- **Hitos**: Inteligencia de mercado extendida a plataformas de segunda mano y marketplaces globales.

- **Estado**: üèóÔ∏è EN PROGRESO



#### 10.3 Inteligencia Wallapop (Segunda Mano)

- **Hitos**: Sistema de importaci√≥n manual integrado en la web del Or√°culo. Pesta√±a "Wallapop" en Admin ‚Üí Config. Formato de entrada: `Nombre | Precio | URL`. Endpoint API: `POST /api/wallapop/import`.

- **Verificado**: 57 productos importados exitosamente al Purgatorio.

- **Limitaci√≥n T√©cnica**: Wallapop usa CloudFront WAF que bloquea scraping automatizado. Soluci√≥n h√≠brida: el usuario navega manualmente y pega los datos en la app.

- **Archivos Creados**:

  - `frontend/src/components/admin/WallapopImporter.tsx` - Componente React con preview en tiempo real.

  - `frontend/src/api/wallapop.ts` - Cliente API y parseador de texto.

  - `src/infrastructure/scrapers/wallapop_manual_importer.py` - Motor de importaci√≥n CLI.

  - `import_wallapop.bat` - Script de acceso r√°pido.

  - `docs/GUIA_WALLAPOP_MANUAL.md` - Gu√≠a de uso.

  - `chrome-extension/` - Extensi√≥n de navegador (opcional, experimental).

- **Estado**: ‚úÖ COMPLETADO (Importaci√≥n Manual Integrada)



---



## FASE 11: ESTABILIZACI√ìN Y AUDITOR√çA EUROPEA (17/01/2026)



### üõ°Ô∏è Correcci√≥n Cr√≠tica: El Basti√≥n de la Fortaleza (ID Sequence Fix)

- **Problema**: El endpoint `/api/collection/toggle` devolv√≠a Error 500 para usuarios no-admin.

- **Causa**: Desincronizaci√≥n de la secuencia de IDs en PostgreSQL (`collection_items_id_seq`). La secuencia intentaba insertar ID 26 en una tabla que ya ten√≠a items hasta el ID 75.

- **Soluci√≥n**: Ejecuci√≥n de `ALTER SEQUENCE collection_items_id_seq RESTART WITH 76`.

- **Resultado**: Registro y captura de items corregido para todos los usuarios.



### üï∏Ô∏è Auditor√≠a Ejecutiva de Scrapers Continentales

- **ToymiEU (EU)**: Auditor√≠a real exitosa. 106 items encontrados y procesados.

- **Time4ActionToys (DE)**: Auditor√≠a real exitosa. 273 items encontrados y procesados.

- **Verificaci√≥n**: Confirmaci√≥n de los 11 scrapers europeos en `daily_scan.py` y configuraci√≥n en GitHub Actions.



### üõ°Ô∏è Blindaje At√≥mico Definitivo (UPSERT)

- **Correcci√≥n Electr√≥polis**: Identificada fuga en la l√≥gica de inserci√≥n de duplicados latentes.

- **Atomic UPSERT**: Implementada l√≥gica `ON CONFLICT (url) DO UPDATE` en el `ScrapingPipeline`. Ahora, cualquier colisi√≥n de URL en PostgreSQL se resuelve actualizando el precio y metadatos autom√°ticamente sin interrumpir el proceso.

- **Data Integrity**: Corregido bug de `is_available` que enviaba `None` a la base de datos, garantizando que el stock sea siempre booleano.

- **Safe Transactions**: Uso estricto de `with db.begin_nested()` para asegurar que cada item sea una unidad at√≥mica independiente.



### üîó Refinamiento de Wallapop (Anti-Bot Bypass)

- **Problema**: Wallapop bloquea enlaces directos (Error 403).

- **Mejora**: Implementaci√≥n de bot√≥n **"Copiar URL"** en el Purgatorio y Dashboard.

- **UX**: Feedback visual ("¬°Copiado!") para una navegaci√≥n sin fricciones.



### üõ°Ô∏è Auditor√≠a de C√≥digo y Refinamiento (The Oracle's Eye)

- **Correcci√≥n de Lints**: Eliminaci√≥n de importaciones no utilizadas (`LinkIcon`) en `Dashboard.tsx`.

- **Blindaje de Rollback**: Corregido `AttributeError` en el script de reversi√≥n ejecutiva.

- **Verificaci√≥n de Pipeline**: Confirmado que `daily_scan.py` integra correctamente los 11 scrapers activos (Espa√±a + Europa).



### üï∏Ô∏è Operaci√≥n "Purgatorio Limpio" (Rollback Total Europeo)

- **Acci√≥n**: Rollback extendido para **Time4ActionToysDE**, **Time4ActionToys** y **ToymiEU**.

- **Resultado**: +234 items de `Time4ActionToysDE` enviados al Purgatorio. Total acumulado de ~300+ items devueltos para auditor√≠a manual tras detectar errores de SmartMatch y precios.

- **Limpieza de Alias**: Se han eliminado los `ProductAliasModel` para evitar que el sistema los vuelva a vincular autom√°ticamente de forma inmediata.



### üß© Estabilidad del Arca (Fixes T√©cnicos)

- **Docker**: Limpieza de cache corrupto mediante `fix_docker_cache.bat` para resolver errores de `snapshot parent`.

- **Frontend**: Eliminaci√≥n de importaciones hu√©rfanas (`Upload`, `LinkIcon`) en `Config.tsx` y `Dashboard.tsx` que bloqueaban la compilaci√≥n de producci√≥n de Vite.



### üåç Refinamiento Europeo (ToymiEU "Spanien" Fix)

- **L√≥gica de Precios**: El scraper `ToymiEUScraper` ahora detecta el selector OSS y fuerza la regi√≥n a **Espa√±a (ES)** antes de iniciar el escaneo.

- **Precisi√≥n**: Mejora en la extracci√≥n de precios priorizando tags `meta[itemprop="price"]` de Schema.org para asegurar que se capture el PVP con IVA espa√±ol.



### üåç Expansi√≥n Continental üá™üá∫ (Fase 11.4)

- **Nuevos Scrapers**: Integraci√≥n de 6 nuevas fuentes europeas (**DeToyboys**, **MotuClassicsDE**, **VendiloshopIT**, **ToymiEU**, **Time4ActionToysDE**, **BigBadToyStore**).

- **Control Total**: Registro centralizado en `spiders_map` con nombres estandarizados (PascalCase).

- **Infraestructura Cloud**: Unificaci√≥n de sesiones de base de datos (`SessionCloud`) en `daily_scan.py`, asegurando que los trabajos autom√°ticos reporten a Supabase en tiempo real.



### üß† Interfaz del Arquitecto (UI Din√°mica)

- **Refactor Purgatorio**: El panel de control de scrapers ya no es est√°tico. Ahora renderiza din√°micamente cualquier tienda registrada en la base de datos.

- **Optimizaci√≥n de Espacio**: Dise√±o compacto (grid adaptativo hasta 8 columnas) para dar cabida a la creciente lista de fuentes sin saturar la vista.

- **Deduplicaci√≥n de Status**: Script de limpieza ejecutado para unificar registros de estado (ej. `actiontoys` -> `ActionToys`).



### üõ†Ô∏è Estabilidad del N√∫cleo

- **Atomicidad SQL**: Implementaci√≥n de `ON CONFLICT DO UPDATE` y `begin_nested()` para inserciones ultra-resilientes en PostgreSQL.



---



### üõ°Ô∏è Operaci√≥n "Coraz√≥n de Grayskull" (Heartbeat & Scraper Fixes - 18/01/2026)

- **BBTS Fix**: Reparado el filtrado por nombre y selector de precios (`.product-card-price`). Superado bloqueo de detecci√≥n de variables.

- **DeToyboys Fix**: Actualizada URL de categor√≠a a la versi√≥n de Mattel/Origins de alto rendimiento. Selectores PrestaShop renovados.

- **Vendiloshop Fix**: Implementada estrategia basada en Sniperfast (Search Overlay) para capturar >2000 productos.

- **Simulador de Latidos**: Creado `simulated_connection.py` para verificaciones de salud ultra-r√°pidas (1 p√°gina) en segundo plano.

- **Estandarizaci√≥n**: Refactorizado `daily_scan.py` para usar el m√©todo proactivo `search()` en lugar del legado `run()`.

- **Compatibilidad**: Eliminados emojis de logs cr√≠ticos para evitar `UnicodeEncodeError` en terminales Windows.



---



- [x] **11.1 Rollback masivo**: Auditor√≠a europea completada y items devueltos al Purgatorio.

- [x] **11.2 Fix ToymiEU**: L√≥gica de selecci√≥n de precios por pa√≠s (Espa√±a) implementada.

- [x] **11.3 Blindaje At√≥mico**: Inserci√≥n resiliente y actualizaci√≥n de precios en Purgatorio.

- [x] **11.4 Expansi√≥n Europea**: 14 scrapers integrados y operativos en UI din√°mica.

- [x] **11.5 Latido del Or√°culo**: Implementado simulador de conexi√≥n y salud de scrapers.

- [x] **11.6 Auditor√≠a de Integridad**: Corregido fallo de inactividad en el Purgatorio (Bulk Discard & Blacklist Logic). Limpieza profunda de scripts temporales.

- [x] **11.7 Consolidaci√≥n de "Nueva Eternia" (19/01/2026)**:

    - **Rebranding UI**: El Or√°culo ahora se denomina oficialmente "Nueva Eternia" en Cat√°logo, Sidebar y Sidebar branding.

    - **Auditor√≠a de Reliquias**: Ejecutada auditor√≠a de paridad. Confirmado cat√°logo de 297 √≠tems (100% de coincidencia con el checklist de ActionFigure411).

    - **Bit√°cora Precisa**: Los logs de incursi√≥n ahora muestran fecha completa (dd/MM/yyyy HH:mm) adem√°s del tiempo relativo.

    - **Vigilancia Autom√°tica**: Verificado el ciclo de 2 ejecuciones diarias en GitHub Actions para las 11 fuentes integradas.

- [x] **11.8 El Nexo Maestro & El Pabell√≥n de Subastas (19/01/2026)**:

    - **Nexus Autom√°tico**: Implementado `NexusService` para sincronizaci√≥n 100% aut√≥noma con ActionFigure411 (Im√°genes, Excel y DB).

    - **Evoluci√≥n del Daily Scan**: El cat√°logo se actualiza autom√°ticamente antes de cada incursi√≥n de precios.

    - **Mando de Arquitecto**: A√±adido bot√≥n "Sincronizar Nexo Maestro" en el panel de Administraci√≥n para control manual.

    - **Estructura de Subastas**: Dise√±ada e implementada la base para el "Pabell√≥n de Subastas", diferenciando ofertas `retail` vs `auction`.

    - **Blindaje de Cohesi√≥n**: Auditor√≠a completa de FigureIDs (100% paridad) y saneamiento del entorno virtual `.venv`.

- [ ] **12.1 Infiltraci√≥n Amazon**: Monitoreo de precios amazon.es.

- [ ] **12.2 Inteligencia eBay**: Conector Browse API + OAuth 2.0.

### Fase 15: El Or√°culo Log√≠stico (Precisi√≥n de Compra)

- **Hitos**: Implementaci√≥n de `LogisticRuleModel` y `LogisticsService`. C√°lculo de *Landed Price* basado en ubicaci√≥n.

- **Estado**: ‚úÖ COMPLETADO Y REFINADO (20/01/2026)

- **Detalle de Refinamiento**:

    - **F√≥rmula de Precisi√≥n**: `(Precio + Env√≠o) * IVA + Tasas Aduaneras`.

    - **Estrategias**: Tarifa plana BBTS ($8) y Fantasia Personajes (5.89‚Ç¨ total).

    - **UI**: Selector de ubicaci√≥n en Configuraci√≥n y desglose de costes en modales.


### Fase 16: Segregacin P2P y Teora de la Cuarentena
- **Hitos**: Evolucin de OfferModel con source_type. Implementacin de GET /api/radar/p2p-opportunities.
- **Estado**: ' COMPLETADO (20/01/2026)
- **Innovacin Tcnica**:
    - **Cuarentena de Precios**: Segregacin lgica total entre Retail y Peer-to-Peer para proteger el valor de mercado de la coleccin.
    - **Percentil 25 (Market Floor)**: Uso de benchmarks histricos de ActionFigure411 para detectar oportunidades reales entre particulares.
    - **Radar UI**: Nueva vista dedicada con micro-animaciones de sonar para visualizacin de 'gangas' detectadas.

### Fase 17: El Centinela de Cross-Validation
- **Hitos**: Implementaci√≥n del `SentinelService` para detecci√≥n de anomal√≠as de precio (40% deviation) y validaci√≥n visual.
- **Estado**: ‚úÖ COMPLETADO (20/01/2026)
- **Logros T√©cnicos**:
    - **Protecci√≥n de Datos**: Bloqueo autom√°tico de ofertas sospechosas movi√©ndolas al Purgatorio con estado `is_blocked`.
    - **Sentinel Service**: L√≥gica de validaci√≥n integrada en el `ScrapingPipeline` para proteger la integridad del cat√°logo.
    - **Control de Arquitecto**: Nuevo endpoint `POST /api/admin/validate-anomaly` para desbloqueo manual de anomal√≠as.
    - **Veredad Visual**: Preparada la base para `master_image_hash` comparando reliquias contra ActionFigure411.

### Fase 18: El Motor de Inversi√≥n (DealScorer)
- **Hitos**: Implementaci√≥n del `DealScorer` para puntuaci√≥n automatizada de oportunidades (1-100).
- **Estado**: ‚úÖ COMPLETADO (20/01/2026)
- **Logros T√©cnicos**:
    - **Opportunity Score**: Algoritmo por vectores que cruza MSRP (40%), P25 (40%) y Wishlist (20%).
    - **Compra Obligatoria**: Sistema de alertas cr√≠ticas (>90 pts + 20% ahorro MSRP) con notificaciones v√≠a Telegram.
    - **Integraci√≥n Total**: El `ScrapingPipeline` ahora inyecta inteligencia financiera en cada hallazgo.
    - **Transparencia**: Exposici√≥n del score en Purgatorio, Radar y endpoints de Dashboard.

- [x] **11.9 Restauraci√≥n de Inteligencia Cloud & CI Recovery (20/01/2026)**:
    - **CI/CD Recovery**: Solucionado error `ModuleNotFoundError: pandas` en GitHub Actions mediante la inyecci√≥n de `pandas`, `openpyxl` y `xlsxwriter` en `requirements.txt`.
    - **Saneamiento Cloud**: Reparada discrepancia de esquemas (`source_type` vs `origin_category`) en Supabase.
    - **Daily Scan Fix**: Corregido el workflow `scrapers.yml` para apuntar a `SUPABASE_DATABASE_URL`, eliminando el modo de pruebas local en la nube.
    - **Nexus Refinement**: Corregida detecci√≥n de `BASE_DIR` y limpieza de precios con s√≠mbolos de moneda (ej: $14.99).
    - **Simetr√≠a Visual**: Eliminada duplicidad de buscadores en el Purgatorio.

- [x] **11.10 Optimizaci√≥n de Rendimiento & UX Core (20/01/2026)**:
    - **Dashboard Speedup**: Eliminadas consultas N+1 en `/api/dashboard/stats` y Hall of Fame. El backend ahora realiza cargas masivas, resolviendo el hang infinito en colecciones grandes.
    - **Logistics Hyper-speed**: Implementado `optimized_get_landing_price` con pre-cach√© de reglas, reduciendo el tiempo de c√°lculo financiero de segundos a milisegundos.
    - **Hero Switch Reliability**: Refactorizado el selector de usuarios en `Navbar.tsx` para asegurar recargas de identidad at√≥micas y consistencia visual entre roles.
    - **Dashboard Resilience**: El Tablero ya no bloquea el renderizado por componentes secundarios; las m√©tricas cr√≠ticas cargan primero para una experiencia instant√°nea.
    - **UI/UX Polish**: Habilitada b√∫squeda funcional en Cat√°logo/Colecci√≥n y corregidos typos cr√≠ticos.

- [x] **11.11 Reparaci√≥n de Daily Scan CLI (20/01/2026)**:
    - **CLI Conflict Fix**: Resuelto error `unrecognized arguments: --shops` en el flujo autom√°tico. El culpable era `personal_collection.py` que ejecutaba su parsing de argumentos al ser llamado como librer√≠a por el Nexus.
    - **Decoupling**: Refactorizada la l√≥gica de scraping de ActionFigure411 para permitir ejecuciones programadas sin interferencias de argumentos CLI.
    - **Robustez**: Mejorado el filtrado de tiendas en `daily_scan.py` para manejar par√°metros vac√≠os de GitHub Actions.

- [x] **11.12 Wallapop DNA & Pavilion Routing (20/01/2026)**:
    - **P2P Tagging**: Corregido endpoint de importaci√≥n para que los √≠tems de Wallapop se marquen como `Peer-to-Peer` autom√°ticamente.

### Fase 21: Blindaje Operativo & Diagn√≥stico (20/01/2026)
- **Hitos**: Correcci√≥n de errores cr√≠ticos de logging y serializaci√≥n. Diagn√≥stico de infraestructura cloud.
- **Estado**: ‚úÖ COMPLETADO
- **Detalle T√©cnico**:
    - **Global Success Logging**: Registro del nivel `SUCCESS` (25) en el logger est√°ndar de Python para evitar `AttributeError`.
    - **DateTime Serialization**: Implementaci√≥n de `DateTimeEncoder` en `BackupManager` para permitir el guardado de snapshots JSON con objetos `datetime`.
    - **Infrastructure Diagnostics**: Logs de arranque en `config.py` para verificar la carga de secretos de Telegram en entornos CI/CD sin fugas de informaci√≥n.

### Fase 21.5: Purgatory-First Policy & Sanaci√≥n (20/01/2026)
- **Hitos**: Cambio de estrategia de flujo de datos y limpieza retroactiva.
- **Estado**: ‚úÖ COMPLETADO
- **Innovaci√≥n Estrat√©gica**:
    - **Purgatory-First Policy**: Desactivaci√≥n del SmartMatch autom√°tico para nuevos items del Daily Scan. El 100% de las nuevas extracciones se derivan ahora al Purgatorio para revisi√≥n manual del Arquitecto.
    - **Sanaci√≥n Retroactiva**: Ejecuci√≥n del script `cleanup_last_matches.py` que revirti√≥ 3 emparejamientos incorrectos (incluyendo el caso Dragstor) devolvi√©ndolos a revisi√≥n manual.
    - **Match Intelligence**: Mejora de los logs de matching para incluir Score, Reason y Deal Score detallados antes del bypass.
    - **Sanitize Purgatory**: Ejecutada migraci√≥n para corregir el "ADN" de los √≠tems existentes de Wallapop en el Purgatorio.
    - **Routing Fix**: Ahora al vincular √≠tems de Wallapop, estos fluyen correctamente hacia **El Pabell√≥n** en lugar del cat√°logo Retail.

    - **Foco Administrativo**: Mejorado el flujo de trabajo en el panel de Admin para una gesti√≥n de reliquias m√°s √°gil.

### Fase 22: Unlink Control - Basti√≥n de Justicia v2 (20/01/2026)
- **Hitos**: Capacidad de revertir vinculaciones directamente desde el Cat√°logo.
- **Estado**: ‚úÖ COMPLETADO
- **Control Total**:
    - **Admin Unlink**: Implementada funcionalidad para que el Arquitecto pueda desvincular ofertas err√≥neas desde el Cat√°logo.
    - **Purgatory Feedback**: Las ofertas desvinculadas regresan instant√°neamente al Purgatorio como items pendientes.
    - **Alias Cleanup**: Borrado autom√°tico del `ProductAlias` asociado a la URL desvinculada para prevenir rematches autom√°ticos incorrectos en futuros escaneos.
    - **Audit Log**: Registro de la acci√≥n como `UNLINKED_MANUAL_ADMIN`.

### Fase 23: Admin Security Hardening (20/01/2026)
- **Hitos**: Blindaje de acciones cr√≠ticas y mejora de la jerarqu√≠a de UI.
- **Estado**: ‚úÖ COMPLETADO
- **Seguridad**:
    - **Relocalizaci√≥n Estrat√©gica**: Movido el bot√≥n "Purificar Datos" (Reset SmartMatches) de la zona activa del Purgatorio a **Ajustes de Sistema** en Configuraci√≥n.
    - **Double Confirmation Pulse**: Implementada l√≥gica de confirmaci√≥n en dos pasos ("¬øEst√°s seguro?" -> "¬°√öltimo aviso!") con cambio din√°mico de color y sem√°ntica visual para evitar ejecuciones accidentales.
    - **UX Protectora**: La nueva "Puerta de Purificaci√≥n" requiere una intenci√≥n clara y sostenida por parte del Arquitecto.
